<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SimulationController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mybank</a> &gt; <a href="index.source.html" class="el_package">com.mybank.controller</a> &gt; <span class="el_source">SimulationController.java</span></div><h1>SimulationController.java</h1><pre class="source lang-java linenums">package com.mybank.controller;

import com.mybank.model.ClientProfile;
import com.mybank.model.DemandeCredit;
import com.mybank.model.Folder;
import com.mybank.service.ClientProfileService;
import com.mybank.service.DemandeCreditService;
import com.mybank.service.LoanApprovalPredictionService;

import jakarta.enterprise.context.SessionScoped;
import jakarta.inject.Inject;
import jakarta.inject.Named;
import java.io.Serializable;

@Named(&quot;simulationController&quot;)
@SessionScoped
<span class="fc" id="L17">public class SimulationController implements Serializable {</span>

    private static final long serialVersionUID = 1L;

    @Inject
    private FolderController folderBean;

    public void setFolderBean(FolderController folderBean) {
<span class="fc" id="L25">        this.folderBean = folderBean;</span>
<span class="fc" id="L26">    }</span>


    @Inject
    private DemandeCreditService demandeCreditService;
    public void setDemandeCreditService(DemandeCreditService demandeCreditService) {
<span class="fc" id="L32">        this.demandeCreditService = demandeCreditService;</span>
<span class="fc" id="L33">    }</span>

    @Inject
    private ClientProfileService clientProfileService;
    public void setClientProfileService(ClientProfileService clientProfileService) {
<span class="fc" id="L38">        this.clientProfileService = clientProfileService;</span>
<span class="fc" id="L39">    }</span>

    @Inject
    private LoanApprovalPredictionService loanApprovalPredictionService;
    public void setLoanApprovalPredictionService(LoanApprovalPredictionService loanApprovalPredictionService) {
<span class="fc" id="L44">        this.loanApprovalPredictionService = loanApprovalPredictionService;</span>
<span class="fc" id="L45">    }</span>

    @Inject
    private ClientProfileController clientProfileController;
    public void setClientProfileController(ClientProfileController clientProfileController) {
<span class="fc" id="L50">        this.clientProfileController = clientProfileController;</span>
<span class="fc" id="L51">    }</span>
    
    private DemandeCredit simulatedResult;
<span class="fc" id="L54">    private boolean loading = false;</span>

    public void simulate() {
<span class="fc" id="L57">        Folder folder = folderBean.getSelectedFolder();</span>
<span class="fc" id="L58">        ClientProfile profile = clientProfileService.findByFolder(folder);</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if (folder == null) return;</span>

<span class="fc" id="L61">        loading = true;</span>

<span class="fc" id="L63">        double montant = folder.getMontantDemande();</span>
<span class="fc" id="L64">        int duree = folder.getDureeMois();</span>
<span class="fc" id="L65">        double tauxAnnuel = folder.getTauxAnnuel();</span>
<span class="fc" id="L66">        double revenuMensuel = folder.getRevenuMensuel();</span>

<span class="fc" id="L68">        double tauxMensuel = tauxAnnuel / 12 / 100;</span>
<span class="fc" id="L69">        double mensualite = (montant * tauxMensuel) / (1 - Math.pow(1 + tauxMensuel, -duree));</span>
<span class="pc bpc" id="L70" title="2 of 4 branches missed.">        double paiementsExistants = profile != null &amp;&amp; profile.getPaiementsMensuelsDette() != null</span>
<span class="pc" id="L71">        	    ? profile.getPaiementsMensuelsDette() : 0.0;</span>
<span class="fc" id="L72">        double tauxEndettementApres = (paiementsExistants + mensualite) / revenuMensuel * 100; // ðŸ§® Get ClientProfile for tauxEndettementAvant calculation</span>
<span class="fc" id="L73">        double tauxEndettementAvant = 0.0;</span>

<span class="pc bpc" id="L75" title="3 of 6 branches missed.">        if (profile != null &amp;&amp; profile.getPaiementsMensuelsDette() != null &amp;&amp; revenuMensuel != 0) {</span>
<span class="fc" id="L76">            tauxEndettementAvant = (profile.getPaiementsMensuelsDette() / revenuMensuel) * 100;</span>
        }

<span class="fc" id="L79">        simulatedResult = new DemandeCredit();</span>
<span class="fc" id="L80">        simulatedResult.setMensualiteEstimee(Math.round(mensualite * 100.0) / 100.0);</span>
<span class="fc" id="L81">        simulatedResult.setTauxEndettement(Math.round(tauxEndettementApres * 100.0) / 100.0);</span>
<span class="fc" id="L82">        simulatedResult.setTauxEndettementAvant(Math.round(tauxEndettementAvant * 100.0) / 100.0); // ðŸ†•</span>
<span class="fc" id="L83">        simulatedResult.setFolder(folder);</span>

<span class="fc" id="L85">        loading = false;</span>
<span class="fc" id="L86">    }</span>
    public void resetSimulation() {
<span class="nc" id="L88">        simulatedResult = null;</span>
<span class="nc" id="L89">    }</span>

    public String getEndettementAdvice() {
<span class="nc bnc" id="L92" title="All 4 branches missed.">        if (simulatedResult == null || simulatedResult.getTauxEndettement() == null) {</span>
<span class="nc" id="L93">            return &quot;&quot;;</span>
        }

<span class="nc" id="L96">        double taux = simulatedResult.getTauxEndettement();</span>

<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (taux &lt;= 33) {</span>
<span class="nc" id="L99">            return &quot;ðŸŸ¢ Endettement Sain (â‰¤ 33%) : Situation stable pour un nouveau prÃªt.&quot;;</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        } else if (taux &lt;= 40) {</span>
<span class="nc" id="L101">            return &quot;ðŸŸ¡ Endettement Limite (33%-40%) : Ã€ analyser avec attention.&quot;;</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">        } else if (taux &lt;= 50) {</span>
<span class="nc" id="L103">            return &quot;ðŸŸ  Endettement Ã‰levÃ© (40%-50%) : Risque important, garanties requises.&quot;;</span>
        } else {
<span class="nc" id="L105">            return &quot;ðŸ”´ Endettement Critique (&gt; 50%) : Demande difficilement acceptable.&quot;;</span>
        }
    }
    public String getAdviceForFolderSimulation() {
<span class="nc" id="L109">        DemandeCredit demande = getDemandeCreditBySelectedFolder();</span>
<span class="nc bnc" id="L110" title="All 4 branches missed.">        if (demande == null || demande.getTauxEndettement() == null) {</span>
<span class="nc" id="L111">            return &quot;&quot;;</span>
        }
<span class="nc" id="L113">        double taux = demande.getTauxEndettement();</span>

<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (taux &lt;= 33) {</span>
<span class="nc" id="L116">            return &quot;ðŸŸ¢ Endettement Sain (â‰¤ 33%) : Situation stable pour un nouveau prÃªt.&quot;;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        } else if (taux &lt;= 40) {</span>
<span class="nc" id="L118">            return &quot;ðŸŸ¡ Endettement Limite (33%-40%) : Ã€ analyser avec attention.&quot;;</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        } else if (taux &lt;= 50) {</span>
<span class="nc" id="L120">            return &quot;ðŸŸ  Endettement Ã‰levÃ© (40%-50%) : Risque important, garanties requises.&quot;;</span>
        } else {
<span class="nc" id="L122">            return &quot;ðŸ”´ Endettement Critique (&gt; 50%) : Demande difficilement acceptable.&quot;;</span>
        }
    }


    public void saveSimulation() {
<span class="nc" id="L128">        Folder selectedFolder = folderBean.getSelectedFolder();</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">        if (selectedFolder == null || simulatedResult == null) return;</span>

<span class="nc" id="L131">        DemandeCredit existing = demandeCreditService.findByFolder(selectedFolder);</span>

<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (existing == null) {</span>
<span class="nc" id="L134">            DemandeCredit demande = new DemandeCredit();</span>
<span class="nc" id="L135">            demande.setFolder(selectedFolder);</span>
<span class="nc" id="L136">            demande.setMensualiteEstimee(simulatedResult.getMensualiteEstimee());</span>
<span class="nc" id="L137">            demande.setTauxEndettement(simulatedResult.getTauxEndettement());</span>
<span class="nc" id="L138">            demande.setTauxEndettementAvant(simulatedResult.getTauxEndettementAvant()); // ðŸ†•</span>
<span class="nc" id="L139">            demandeCreditService.save(demande);</span>
<span class="nc" id="L140">        } else {</span>
<span class="nc" id="L141">            existing.setMensualiteEstimee(simulatedResult.getMensualiteEstimee());</span>
<span class="nc" id="L142">            existing.setTauxEndettement(simulatedResult.getTauxEndettement());</span>
<span class="nc" id="L143">            existing.setTauxEndettementAvant(simulatedResult.getTauxEndettementAvant()); // ðŸ†•</span>
<span class="nc" id="L144">            demandeCreditService.update(existing);</span>
        }

<span class="nc" id="L147">        simulatedResult = null;</span>
<span class="nc" id="L148">        folderBean.reloadSelectedFolder();</span>
<span class="nc" id="L149">    }</span>

    public DemandeCredit getDemandeCreditBySelectedFolder() {
<span class="nc" id="L152">        Folder folder = folderBean.getSelectedFolder();</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (folder == null) return null;</span>
<span class="nc" id="L154">        return demandeCreditService.findByFolder(folder);</span>
    }
    
    private boolean loanApproved;
    private Double approvalProbability;
    private Double predictedRiskScore;

    public void checkLoanApproval() {
<span class="nc" id="L162">        Folder folder = folderBean.getSelectedFolder();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (folder == null) {</span>
<span class="nc" id="L164">            this.loanApproved = false;</span>
<span class="nc" id="L165">            this.approvalProbability = null;</span>
<span class="nc" id="L166">            this.predictedRiskScore = null;</span>
<span class="nc" id="L167">            return;</span>
        }

<span class="nc" id="L170">        ClientProfile profile = clientProfileService.findByFolder(folder);</span>
<span class="nc" id="L171">        DemandeCredit demande = getDemandeCreditBySelectedFolder();</span>

<span class="nc bnc" id="L173" title="All 4 branches missed.">        if (profile == null || demande == null) {</span>
<span class="nc" id="L174">            this.loanApproved = false;</span>
<span class="nc" id="L175">            this.approvalProbability = null;</span>
<span class="nc" id="L176">            this.predictedRiskScore = null;</span>
<span class="nc" id="L177">            return;</span>
        }

<span class="nc" id="L180">        LoanApprovalPredictionService.PredictionResult result = loanApprovalPredictionService.predictLoanApproval(</span>
<span class="nc" id="L181">            profile.getAge(),</span>
<span class="nc" id="L182">            profile.getScoreCredit(),</span>
<span class="nc" id="L183">            profile.getStatutEmploi(),</span>
<span class="nc" id="L184">            folder.getMontantDemande(),</span>
<span class="nc" id="L185">            folder.getDureeMois(),</span>
<span class="nc" id="L186">            profile.getStatutMatrimonial(),</span>
<span class="nc" id="L187">            profile.getStatutPropriete(),</span>
<span class="nc" id="L188">            folder.getRevenuMensuel(),</span>
<span class="nc" id="L189">            demande.getTauxEndettement()/100,</span>
<span class="nc" id="L190">            profile.getPrecedentsDefautsPret(),</span>
<span class="nc" id="L191">            profile.getHistoriquePaiement(),</span>
<span class="nc" id="L192">            profile.getHistoriqueFaillite(),</span>
<span class="nc" id="L193">            demande.getMensualiteEstimee(),</span>
<span class="nc" id="L194">            profile.getPaiementsMensuelsDette(),</span>
<span class="nc" id="L195">            profile.getValeurNette(),</span>
<span class="nc" id="L196">            folder.getTauxAnnuel()/100</span>
        );

<span class="nc" id="L199">        this.loanApproved = result.isLoanApproved();</span>
<span class="nc" id="L200">        this.approvalProbability = result.getApprovalProbability();</span>
<span class="nc" id="L201">        this.predictedRiskScore = result.getRiskScore();</span>
        
<span class="nc" id="L203">        profile.setPretApprouve(loanApproved);</span>
<span class="nc" id="L204">        profile.setScoreRisque(predictedRiskScore);</span>
<span class="nc" id="L205">        profile.setProbabiliteApprobation(String.format(&quot;%.2f&quot;, approvalProbability));</span>
<span class="nc" id="L206">        clientProfileService.update(profile);</span>
<span class="nc" id="L207">        clientProfileController.loadProfile();</span>
<span class="nc" id="L208">    }</span>

    public boolean getLoanApproved() {
<span class="nc" id="L211">        return loanApproved;</span>
    }

    public Double getApprovalProbability() {
<span class="nc" id="L215">        return approvalProbability;</span>
    }

    public Double getPredictedRiskScore() {
<span class="nc" id="L219">        return predictedRiskScore;</span>
    }

    

    // Getters &amp; Setters
<span class="fc" id="L225">    public DemandeCredit getSimulatedResult() { return simulatedResult; }</span>
<span class="nc" id="L226">    public void setSimulatedResult(DemandeCredit simulatedResult) { this.simulatedResult = simulatedResult; }</span>
<span class="nc" id="L227">    public boolean isLoading() { return loading; }</span>
<span class="nc" id="L228">    public void setLoading(boolean loading) { this.loading = loading; }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>