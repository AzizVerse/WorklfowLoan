<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AgencyController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mybank</a> &gt; <a href="index.source.html" class="el_package">com.mybank.controller</a> &gt; <span class="el_source">AgencyController.java</span></div><h1>AgencyController.java</h1><pre class="source lang-java linenums">package com.mybank.controller;

import com.mybank.model.Agency;
import com.mybank.model.Folder;
import com.mybank.model.User;
import com.mybank.service.AgencyService;
import com.mybank.service.FolderService;
import com.mybank.service.UserService;

import jakarta.annotation.PostConstruct;
import jakarta.enterprise.context.SessionScoped;
import jakarta.inject.Inject;
import jakarta.inject.Named;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;

/**
 * JSF managed bean - must use field injection due to JSF lifecycle requirements.
 * Constructor injection causes deployment issues (e.g. WELD-001410).
 */
@Named(&quot;agencyBean&quot;)
@SessionScoped
@SuppressWarnings(&quot;squid:S6813&quot;) // Sonar false positive: field injection is required in JSF
<span class="fc" id="L25">public class AgencyController implements Serializable {</span>
	 private static final long serialVersionUID = 1L;
        
	// NOSONAR: Field injection is used intentionally in JSF managed beans
	    @Inject
	    private AgencyService agencyService;
	 // NOSONAR: Field injection is used intentionally in JSF managed beans
	    @Inject
	    private UserService userService;
	 // NOSONAR: Field injection is used intentionally in JSF managed beans
	    @Inject
	    private FolderService folderService;

	    // Setter Injection for testing
	    public void setAgencyService(AgencyService agencyService) {
<span class="fc" id="L40">	        this.agencyService = agencyService;</span>
<span class="fc" id="L41">	    }</span>

	    public void setUserService(UserService userService) {
<span class="fc" id="L44">	        this.userService = userService;</span>
<span class="fc" id="L45">	    }</span>

	    public void setFolderService(FolderService folderService) {
<span class="fc" id="L48">	        this.folderService = folderService;</span>
<span class="fc" id="L49">	    }</span>
    
    

    private String code;
    private String name;
    private Long directorId;
    private String creationMessage;

    private transient List&lt;Agency&gt; agencyList;
    private transient Agency selectedAgency;
    
<span class="fc" id="L61">    private transient List&lt;Folder&gt; externalFolders = new ArrayList&lt;&gt;();</span>

    public List&lt;Folder&gt; getExternalFolders() {
<span class="nc" id="L64">        return externalFolders;</span>
    }


    @PostConstruct
    public void init() {
<span class="fc" id="L70">        agencyList = agencyService.findAllAgencies();</span>
<span class="fc" id="L71">    }</span>

    public String createAgency() {
<span class="fc" id="L74">        User director = userService.findById(directorId);</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (director == null) {</span>
<span class="fc" id="L76">            creationMessage = &quot;Directeur introuvable.&quot;;</span>
<span class="fc" id="L77">            return null;</span>
        }

        // Check if this director is already assigned
<span class="fc" id="L81">        boolean isAlreadyDirector = agencyList.stream()</span>
<span class="pc bnc" id="L82" title="All 4 branches missed.">                .anyMatch(a -&gt; a.getDirector() != null &amp;&amp; a.getDirector().getId().equals(directorId));</span>

<span class="pc bpc" id="L84" title="1 of 2 branches missed.">        if (isAlreadyDirector) {</span>
<span class="nc" id="L85">            creationMessage = &quot;Ce directeur est déjà affecté à une agence.&quot;;</span>
<span class="nc" id="L86">            return null;</span>
        }

<span class="fc" id="L89">        Agency agency = new Agency(code, name, director);</span>
<span class="fc" id="L90">        agencyService.createAgency(agency);</span>
<span class="fc" id="L91">        creationMessage = &quot;Agence créée avec succès.&quot;;</span>
<span class="fc" id="L92">        clearForm();</span>
<span class="fc" id="L93">        agencyList = agencyService.findAllAgencies(); // refresh list</span>
<span class="fc" id="L94">        return null;</span>
    }

    private void clearForm() {
<span class="fc" id="L98">        code = &quot;&quot;;</span>
<span class="fc" id="L99">        name = &quot;&quot;;</span>
<span class="fc" id="L100">        directorId = null;</span>
<span class="fc" id="L101">    }</span>

    public List&lt;User&gt; getAvailableDirectors() {
<span class="fc" id="L104">        List&lt;User&gt; allDirectors = userService.findUsersByRole(&quot;DIRECTEUR_AGENCE&quot;);</span>
        // filter out already-assigned ones
<span class="fc" id="L106">        return allDirectors.stream()</span>
<span class="fc" id="L107">                .filter(director -&gt; agencyList.stream()</span>
<span class="pc bpc" id="L108" title="1 of 4 branches missed.">                        .noneMatch(a -&gt; a.getDirector() != null &amp;&amp; a.getDirector().getId().equals(director.getId())))</span>
<span class="fc" id="L109">                .toList();</span>
    }

    public List&lt;Agency&gt; getAllAgencies() {
<span class="nc" id="L113">        return agencyList;</span>
    }
    public List&lt;Agency&gt; getAgencies() {
<span class="nc" id="L116">        return agencyList;</span>
    }
    
    

    
    public Agency getSelectedAgency() {
<span class="nc" id="L123">        return selectedAgency;</span>
    }

    public void setSelectedAgency(Agency selectedAgency) {
<span class="nc" id="L127">        this.selectedAgency = selectedAgency;</span>
<span class="nc" id="L128">    }</span>

    
    public long folderCountForAnalyst(User analyst) {
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (analyst == null) return 0;</span>
<span class="nc" id="L133">        return folderService.getFolderCountForAnalyst(analyst); // Already filtered by !TERMINE</span>
    }
    public long folderCountForCICAnalyst(User cicAnalyst) {
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (cicAnalyst == null) return 0;</span>
<span class="nc" id="L137">        return folderService.getFolderCountForCICAnalyst(cicAnalyst); // à implémenter dans service</span>
    }
    public long externalFolderCountForCIC(User cicAnalyst, Agency agency) {
<span class="nc bnc" id="L140" title="All 4 branches missed.">        if (cicAnalyst == null || agency == null) return 0;</span>
<span class="nc" id="L141">        return folderService.countExternalCICFolders(cicAnalyst, agency); // à implémenter dans service</span>
    }
    public void loadExternalCICOrigins(User cicAnalyst, Agency agency) {
<span class="nc" id="L144">        originAgencyNames = folderService.getOriginAgencyNamesForCIC(cicAnalyst, agency);</span>
<span class="nc" id="L145">        externalFolders = folderService.getExternalFoldersForCICAnalyst(cicAnalyst, agency);</span>
<span class="nc" id="L146">    }</span>


    public long externalFolderCount(User analyst, Agency agency) {
<span class="nc bnc" id="L150" title="All 4 branches missed.">        if (analyst == null || agency == null) return 0;</span>
<span class="nc" id="L151">        return folderService.countFoldersFromOtherAgencies(analyst, agency); // Already filtered by !TERMINE</span>
    }

<span class="fc" id="L154">    private List&lt;String&gt; originAgencyNames = new ArrayList&lt;&gt;();</span>

    public void loadExternalOrigins(User analyst, Agency agency) {
<span class="nc" id="L157">        originAgencyNames = folderService.getOriginAgencyNamesForExternalFolders(analyst, agency);</span>
<span class="nc" id="L158">        externalFolders = folderService.getExternalFoldersForAnalyst(analyst, agency);</span>
<span class="nc" id="L159">    }</span>

    public List&lt;String&gt; getOriginAgencyNames() {
<span class="nc" id="L162">        return originAgencyNames;</span>
    }
    public List&lt;Folder&gt; getExternalFoldersForAnalyst(User analyst, Agency agency) {
<span class="nc bnc" id="L165" title="All 4 branches missed.">        if (analyst == null || agency == null) return List.of();</span>
<span class="nc" id="L166">        return folderService.getExternalFoldersForAnalyst(analyst, agency);</span>
    }


    // Getters and Setters
<span class="nc" id="L171">    public String getCode() { return code; }</span>
<span class="fc" id="L172">    public void setCode(String code) { this.code = code; }</span>

<span class="nc" id="L174">    public String getName() { return name; }</span>
<span class="fc" id="L175">    public void setName(String name) { this.name = name; }</span>

<span class="nc" id="L177">    public Long getDirectorId() { return directorId; }</span>
<span class="fc" id="L178">    public void setDirectorId(Long directorId) { this.directorId = directorId; }</span>

<span class="fc" id="L180">    public String getCreationMessage() { return creationMessage; }</span>
<span class="nc" id="L181">    public void setCreationMessage(String creationMessage) { this.creationMessage = creationMessage; }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>